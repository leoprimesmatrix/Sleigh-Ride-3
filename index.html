<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sleigh Ride 3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Orbitron:wght@400;700&family=Mountains+of+Christmas:wght@400;700&display=swap');
    
    body {
      font-family: 'Cinzel', serif;
      background-color: #0f0f0f;
      color: #e2e8f0;
      overflow: hidden;
    }

    /* Cinematic Text */
    .cinematic-text {
      text-shadow: 0 0 10px rgba(251, 191, 36, 0.6), 0 0 20px rgba(220, 38, 38, 0.4);
    }

    /* Glitch Effect - Activates later via JS classes */
    .glitch-active {
      position: relative;
      animation: glitch-skew 1s infinite linear alternate-reverse;
      font-family: 'Orbitron', sans-serif !important;
    }
    .glitch-active::before, .glitch-active::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .glitch-active::before {
      left: 2px;
      text-shadow: -1px 0 #ff00c1;
      clip: rect(44px, 450px, 56px, 0);
      animation: glitch-anim 5s infinite linear alternate-reverse;
    }
    .glitch-active::after {
      left: -2px;
      text-shadow: -1px 0 #00fff9;
      clip: rect(44px, 450px, 56px, 0);
      animation: glitch-anim2 5s infinite linear alternate-reverse;
    }

    @keyframes glitch-anim {
      0% { clip: rect(12px, 9999px, 32px, 0); }
      20% { clip: rect(65px, 9999px, 89px, 0); }
      40% { clip: rect(10px, 9999px, 98px, 0); }
      60% { clip: rect(2px, 9999px, 12px, 0); }
      80% { clip: rect(34px, 9999px, 67px, 0); }
      100% { clip: rect(89px, 9999px, 99px, 0); }
    }
    @keyframes glitch-anim2 {
      0% { clip: rect(65px, 9999px, 100px, 0); }
      20% { clip: rect(2px, 9999px, 23px, 0); }
      40% { clip: rect(45px, 9999px, 56px, 0); }
      60% { clip: rect(1px, 9999px, 8px, 0); }
      80% { clip: rect(23px, 9999px, 67px, 0); }
      100% { clip: rect(89px, 9999px, 12px, 0); }
    }

    /* Loader */
    #loader {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center, #2b0a0a, #000);
      z-index: 9999;
      transition: opacity 0.5s;
    }
    
    .snow-loader {
      width: 60px;
      height: 60px;
      position: relative;
      animation: spin 3s linear infinite;
    }
    .snow-loader::before, .snow-loader::after {
      content: '‚ùÑ';
      position: absolute;
      font-size: 40px;
      color: #fbbf24;
      top: 0; left: 10px;
    }
    .snow-loader::after {
      transform: rotate(45deg);
      color: #fff;
    }

    @keyframes spin { 
        100% { transform: rotate(360deg); } 
    }

  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
  <div id="root"></div>
  
  <div id="loader">
    <div class="snow-loader"></div>
    <h2 class="cinematic-text text-xl text-yellow-500 mt-6 tracking-[0.2em] font-bold font-serif">PREPARING SLEIGH LAUNCH</h2>
    <p id="loader-status" class="text-red-200/80 text-xs mt-2 font-serif italic">Checking reindeer harnesses...</p>
    <div id="error-container" class="hidden mt-4 p-4 bg-red-950 border border-red-500 rounded text-red-200 text-xs text-left max-w-md overflow-auto max-h-60 whitespace-pre-wrap font-mono"></div>
  </div>

  <script>
    async function loadGame() {
      const status = document.getElementById('loader-status');
      const errorContainer = document.getElementById('error-container');
      
      const path = window.location.pathname;
      if (!path.endsWith('/') && !path.endsWith('.html')) {
        const newUrl = window.location.href.replace(path, path + '/');
        window.location.replace(newUrl);
        return; 
      }

      function showError(msg, details = "") {
        status.innerText = "LAUNCH FAILED";
        status.style.color = "#ef4444";
        errorContainer.classList.remove('hidden');
        errorContainer.innerHTML = `<strong>${msg}</strong><br/><br/>${details}`;
      }

      const fileMap = {
        'types.ts': './types.ts',
        'constants.ts': './constants.ts',
        'audio.ts': './audio.ts',
        'VictorySequence.tsx': './components/VictorySequence.tsx',
        'UIOverlay.tsx': './components/UIOverlay.tsx',
        'GameCanvas.tsx': './components/GameCanvas.tsx',
        'App.tsx': './App.tsx',
        'index.tsx': './index.tsx'
      };

      const blobUrls = {};

      async function fetchWithFallback(url) {
        try {
          const res = await fetch(url);
          if (res.ok) return await res.text();
          throw new Error(`HTTP ${res.status}`);
        } catch (err) {
          const parts = url.split('/');
          const filename = parts.pop();
          const capitalized = filename.charAt(0).toUpperCase() + filename.slice(1);
          const newUrl = [...parts, capitalized].join('/');
          
          if (newUrl !== url) {
             const retryRes = await fetch(newUrl);
             if (retryRes.ok) return await retryRes.text();
          }
          throw err;
        }
      }

      try {
        if (window.location.protocol === 'file:') throw new Error("CORS_ERROR");

        for (const [moduleName, serverPath] of Object.entries(fileMap)) {
          // Add festive loading messages
          const festiveMessages = [
              "Polishing bells...",
              "Loading snowflakes...",
              "Checking Naughty List...",
              "Calibrating magic...",
              "Warming up cocoa..."
          ];
          status.innerText = `${festiveMessages[Math.floor(Math.random() * festiveMessages.length)]} (${moduleName})`;
          
          try {
            let code = await fetchWithFallback(serverPath);
            code = code.replace(/(from\s+['"])(?:.*\/)?([a-zA-Z0-9_-]+\.[a-zA-Z]+)(['"])/g, '$1$2$3');

            const result = Babel.transform(code, {
              presets: [['react', { runtime: 'automatic' }], 'typescript'],
              filename: moduleName,
            });

            const blob = new Blob([result.code], { type: 'text/javascript' });
            blobUrls[moduleName] = URL.createObjectURL(blob);

          } catch (fetchErr) {
            console.error(fetchErr);
            if (fetchErr.message === 'CORS_ERROR') throw new Error("CORS RESTRICTION DETECTED");
            throw new Error(`LOAD ERROR ${moduleName}: ${fetchErr.message}`);
          }
        }

        const existingMapEl = document.querySelector('script[type="importmap"]');
        const imports = existingMapEl ? JSON.parse(existingMapEl.textContent).imports : {};

        for (const [moduleName, blobUrl] of Object.entries(blobUrls)) {
          imports[moduleName] = blobUrl;
        }

        const mapEl = document.createElement('script');
        mapEl.type = 'importmap';
        mapEl.textContent = JSON.stringify({ imports });
        document.head.appendChild(mapEl);

        status.innerText = "READY FOR TAKEOFF!";
        await import(blobUrls['index.tsx']);
        
        const loader = document.getElementById('loader');
        loader.style.opacity = '0';
        setTimeout(() => loader.remove(), 500);

      } catch (error) {
        showError("CRITICAL MAGIC FAILURE", error.message);
      }
    }

    if (typeof Babel !== 'undefined') {
      loadGame();
    } else {
      document.querySelector('script[src*="babel"]').onload = loadGame;
    }
  </script>
</body>
</html>